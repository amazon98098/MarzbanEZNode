import logging
import json
import requests
from hcloud import Client
from hcloud.images import Image
from hcloud.server_types import ServerType

TKCLOUD = input("Please Enter Token: ")

# Hetzner token and informations
hcloudClient = Client(
    token=TKCLOUD,  # Please paste your API token here
    application_name="my-app",
    application_version="v1.0.0",
)

# Configure logging
logging.basicConfig(level=logging.INFO)

# Marzban Information
DOMAIN = "myblog.intonature.tech"
PORT = 443
USERNAME = "z"
PASSWORD = "z"
HTTPS = True  # Set this to True for HTTPS, False for HTTP

ADD_AS_HOST = False  # Set this to True if you want to add node on all hosts, otherwise set to False

# Node Server Configuration
# print("-" * 15)
# print("Node Server Information")

# Create a reusable session
session = requests.Session()

def get_access_token(username, password):
    use_protocol = 'https' if HTTPS else 'http'
    url = f'{use_protocol}://{DOMAIN}:{PORT}/api/admin/token'
    data = {
        'username': username,
        'password': password
    }

    try:
        response = session.post(url, data=data)
        response.raise_for_status()
        access_token = response.json()['access_token']
        logging.info(".:Logged in Successfully:.")
        return access_token
    except requests.exceptions.RequestException as e:
        logging.error(f'Error occurred while obtaining access token: {e}')
        return None


def get_cert(access_token):
    use_protocol = 'https' if HTTPS else 'http'
    url = f'{use_protocol}://{DOMAIN}:{PORT}/api/node/settings'
    headers = {
        'accept': 'application/json',
        'Authorization': f'Bearer {access_token}'
    }

    try:
        response = session.get(url, headers=headers)
        response.raise_for_status()
        cert = response.json()
        return cert["certificate"]
    except requests.exceptions.RequestException as e:
        logging.error(f'Error occurred while retrieving certificate: {e}')
        return None


def add_node(access_token, server_ip):
    use_protocol = 'https' if HTTPS else 'http'
    url = f'{use_protocol}://{DOMAIN}:{PORT}/api/node'
    node_information = {
        "name": f"{server_ip} - github.com/itsAML",
        "address": f"{server_ip}",
        "port": 8530,
        "api_port": 8531,
        "add_as_new_host": True if ADD_AS_HOST else False,
        "usage_coefficient": 1
    }
    node_json_information = json.dumps(node_information)
    headers = {
        'accept': 'application/json',
        'Authorization': f'Bearer {access_token}'
    }

    try:
        response = session.post(url, node_json_information, headers=headers)
        response.raise_for_status()
        return print("Node Added Successfully")
    except requests.exceptions.RequestException as e:
        logging.error(f'Error occurred while adding node: {e}')
        return None


# Certificate information
access_token = get_access_token(USERNAME, PASSWORD)
cert_info = get_cert(access_token)


def get_nodes(access_token):
    use_protocol = 'https' if HTTPS else 'http'
    url = f'{use_protocol}://{DOMAIN}:{PORT}/api/nodes'
    headers = {
        'accept': 'application/json',
        'Authorization': f'Bearer {access_token}'
    }

    response = session.get(url, headers=headers)
    response.raise_for_status()
    return response.json()


def delete_node(access_token, node_id):
    use_protocol = 'https' if HTTPS else 'http'
    url = f'{use_protocol}://{DOMAIN}:{PORT}/api/node/{node_id}'
    headers = {
        'accept': 'application/json',
        'Authorization': f'Bearer {access_token}'
    }

    response = session.delete(url, headers=headers)
    response.raise_for_status()
    logging.info(f"Node {node_id} deleted successfully")


def cleanup_disconnected_nodes(access_token):
    nodes = get_nodes(access_token)

    for node in nodes:
        status = node.get("status")
        node_id = node.get("id")
        name = node.get("name")

        if status in {"disconnected", "offline", "error", "disabled"}:
            logging.warning(f"Removing node {name} (status={status})")
            delete_node(access_token, node_id)


access_token = get_access_token(USERNAME, PASSWORD)

cleanup_disconnected_nodes(access_token)

# # List your servers
servers = hcloudClient.servers.get_all()
if servers:
    for server in servers:
        print(server.public_net.ipv4.ip)

        server_node_ip = server.public_net.ipv4.ip

        try:
            print("Adding Node To The Panel:")
            add_node(access_token, server_node_ip)
        except Exception as e:
            pass
